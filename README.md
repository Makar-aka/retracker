# retracker

retracker — это легковесный BitTorrent-трекер на Flask.  
Работает как в интерактивном режиме (консоль), так и как systemd-сервис.

---

## Возможности

- BitTorrent-трекер с поддержкой announce/scrape
- Веб-интерфейс статистики с авторизацией (Flask-сессии)
- Гибкая настройка через переменные окружения и `.env`
- Логирование с ротацией
- Универсальный запуск: консоль, systemd, Docker/Docker Compose
- Поддержка работы в режимах **proxy** и **direct**
---

## Зачем нужен? 
•	Для локальных сетей (на пример, провайдера или внутри организации).\
•	Для частных торрент-сообществ.\
•	Для тестирования и разработки BitTorrent-клиентов.\
•	Для случаев, когда нужен простой и прозрачный трекер без лишних функций.

`retracker не требует регистрации пользователей, не хранит файлы, а только координирует пиры для обмена данными по протоколу BitTorrent.`

## Быстрый старт

### 1. Клонирование репозитория
```
git clone https://github.com/Makar-aka/retracker.git
cd retracker
```
### 2. Настройка конфигурации

Скопируйте пример конфига и отредактируйте под себя:

cp .env.example .env


**Обязательные параметры:**
- `[FLASK]` — секретный ключ для сессий авторизации в статистике
- `[STATS]` — логин и пароль для входа в статистику
- `[TRACKER]` — порт, host, интервал анонса и др.

---

## Режимы работы: proxy и direct

Трекер может работать в двух режимах, которые задаются переменной окружения `TRACKER_MODE`:

- `direct` — прямое подключение, IP-адрес клиента берётся из стандартного соединения (по умолчанию).
- `proxy` — используется, если трекер работает за обратным прокси (например, nginx, haproxy). В этом режиме трекер определяет реальный IP клиента по заголовкам `X-Real-IP` и/или `X-Forwarded-For`.

Используйте режим `proxy`, если:
- Вы запускаете трекер за nginx, haproxy, cloudflare или другим обратным прокси.
- Вам нужно видеть реальные IP-адреса пользователей, а не адрес прокси.

Используйте режим `direct`, если:
- Трекер доступен напрямую, без прокси-сервера.
- Вы хотите получать IP-адреса клиентов напрямую из соединения.
 
## Конфигурация

**Все настройки теперь задаются через переменные окружения или файл `.env`.**  
Пример файла: [.env.example](./.env.example)
```ini
FLASK_SECRET_KEY=your-very-secret-key
STATS_ACCESS_USERNAME=admin
STATS_ACCESS_PASSWORD=admin 
TRACKER_MODE=direct 
TRACKER_HOST=0.0.0.0 
TRACKER_PORT=8088 
TRACKER_ANNOUNCE_INTERVAL=1800 
TRACKER_PEER_EXPIRE_FACTOR=2.5 
TRACKER_IGNORE_IP=192.168.0.0/16 172.16.0.0/12 127.0.0.1 
TRACKER_NUMWANT=50 
TRACKER_RUN_GC_KEY=gc 
TRACKER_PEER_CLEANUP_PERIOD=600 
LOGGING_LEVEL=INFO 
LOGGING_LOG_FILE=/data/tracker.log 
LOGGING_CONSOLE_OUTPUT=true
```

**Все доступные переменные и их значения смотрите в `.env.example`.**

### Пояснение некоторыйх параметров:
announce_interval = 1800\
Интервал анонсирования (в секундах).\
Это время, через которое BitTorrent-клиенты должны снова отправлять запрос announce на трекер. Обычно 1800 секунд = 30 минут.

peer_expire_factor = 2.5\
Коэффициент "устаревания" пиров.\
Пир считается "мертвым" и удаляется из базы, если не обновлялся дольше, чем announce_interval * peer_expire_factor.
В данном случае: 1800 * 2.5 = 4500 секунд (1 час 15 минут).

numwant = 50\
Сколько пиров возвращать клиенту в ответе на announce.\
Ограничивает максимальное количество пиров, которые трекер отдаёт в одном ответе (по умолчанию 50).

run_gc_key = gc\
Ключ для ручного запуска сборки мусора (очистки устаревших пиров).\
Если в запросе announce есть параметр с этим ключом (?gc), трекер запускает очистку "мертвых" пиров.

## Локальный запуск (консоль)

1. Установите зависимости:
```sh
pip install -r requirements.txt
```
2. Запустите сервер:
```sh
python3 main.py
```

---

## Запуск как systemd-сервис

1. Скопируйте и отредактируйте `retracker.service_example`:
    - Укажите абсолютные пути к рабочей директории и main.py
    - Укажите пользователя и группу

2. Скопируйте файл в `/etc/systemd/system/retracker.service` и выполните:

```sh
sudo systemctl daemon-reload
sudo systemctl enable --now retracker
```

---

## Вход в статистику

- Откройте `http://ваш_сервер/stat` в браузере.
- Введите логин и пароль из секции `[STATS]` файла config.ini.

---
## Запуск через Docker Compose

1. Скопируйте и настройте `.env`:
```
cp .env.example .env
```
2. Запустите:
```
docker-compose up --build

```

---

## Вход в статистику

- Откройте `http://ваш_сервер:порт/stat` в браузере.
- Введите логин и пароль из `.env` (`STATS_ACCESS_USERNAME` и `STATS_ACCESS_PASSWORD`).

---

## Обновление

```
git pull 

systemctl restart retracker

```

---

## Лицензия

MIT

---

Автор: [MakarSPB](https://github.com/Makar-aka)
