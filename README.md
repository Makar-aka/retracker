# retracker

retracker — это легковесный BitTorrent-трекер на Flask.  
Работает как в интерактивном режиме (консоль), так и как systemd-сервис.

---

## Возможности

- BitTorrent-трекер с поддержкой announce/scrape
- Веб-интерфейс статистики с авторизацией (Flask-сессии)
- Гибкая настройка через config.ini
- Логирование с ротацией
- Универсальный запуск: консоль, systemd
- Поддержка работы в режимах **proxy** и **direct**
---

## Зачем нужен? 
•	Для локальных сетей (на пример, провайдера или внутри организации).\
•	Для частных торрент-сообществ.\
•	Для тестирования и разработки BitTorrent-клиентов.\
•	Для случаев, когда нужен простой и прозрачный трекер без лишних функций.

`retracker не требует регистрации пользователей, не хранит файлы, а только координирует пиры для обмена данными по протоколу BitTorrent.`

## Быстрый старт

### 1. Клонирование репозитория
```
git clone https://github.com/Makar-aka/retracker.git cd retracker
```
### 2. Настройка конфигурации

Скопируйте пример конфига и отредактируйте под себя:

cp config/config_example.ini config/config.ini


**Обязательные параметры:**
- `[FLASK]` — секретный ключ для сессий авторизации в статистике
- `[STATS]` — логин и пароль для входа в статистику
- `[TRACKER]` — порт, host, интервал анонса и др.

---

## Режимы работы: proxy и direct

Трекер может работать в двух режимах, которые задаются параметром `mode` в секции `[TRACKER]` файла `config.ini`:

- `direct` — прямое подключение, IP-адрес клиента берётся из стандартного соединения (по умолчанию).
- `proxy` — используется, если трекер работает за обратным прокси (например, nginx, haproxy). В этом режиме трекер определяет реальный IP клиента по заголовкам `X-Real-IP` и/или `X-Forwarded-For`.

Если трекер работает за обратным прокси-сервером, то все входящие подключения для приложения будут приходить с одного и того же IP-адреса (адреса прокси). В этом случае невозможно определить реальный IP-адрес пользователя стандартным способом.  
Режим `proxy` позволяет получать настоящий IP-адрес клиента из специальных HTTP-заголовков, которые прокси-сервер добавляет к каждому запросу. Это важно для корректной работы трекера, учёта пиров и предотвращения злоупотреблений.

Используйте режим `proxy`, если:
- Вы запускаете трекер за nginx, haproxy, cloudflare или другим обратным прокси.
- Вам нужно видеть реальные IP-адреса пользователей, а не адрес прокси.

- Чтобы режим `proxy` работал корректно, прокси-сервер должен передавать реальный IP клиента в заголовках\
см. доки по настройке вашего прокси-сервера.

Используйте режим `direct`, если:
- Трекер доступен напрямую, без прокси-сервера.
- Вы хотите получать IP-адреса клиентов напрямую из соединения.
 
## Конфигурация

Все настройки — в `config/config.ini`.  
Пример секций:
```ini
[FLASK] 
secret_key = ваш_рандомный_ключик_для_сессий_авторизации
[LOGGING]
log_file = tracker.log 
level = INFO 
format = %(asctime)s [%(levelname)s] %(message)s 
console_output = True 
max_bytes = 5242880 
backup_count = 5 
clear_on_start = False

[TRACKER] 
host = 0.0.0.0 
port = 8080 
announce_interval = 1800 
peer_expire_factor = 2 
ignore_ip = 192.168.0.0/8 127.0.0.1 172.16.0.0/8
numwant = 50 
run_gc_key = gc

[CACHE] 
type = sqlite

[DB] 
type = sqlite

[STATS] 
access_username = admin 
access_password = password
```
### Пояснение некоторыйх параметров:
announce_interval = 1800\
Интервал анонсирования (в секундах).\
Это время, через которое BitTorrent-клиенты должны снова отправлять запрос announce на трекер. Обычно 1800 секунд = 30 минут.

peer_expire_factor = 2.5\
Коэффициент "устаревания" пиров.\
Пир считается "мертвым" и удаляется из базы, если не обновлялся дольше, чем announce_interval * peer_expire_factor.
В данном случае: 1800 * 2.5 = 4500 секунд (1 час 15 минут).

numwant = 50\
Сколько пиров возвращать клиенту в ответе на announce.\
Ограничивает максимальное количество пиров, которые трекер отдаёт в одном ответе (по умолчанию 50).

run_gc_key = gc\
Ключ для ручного запуска сборки мусора (очистки устаревших пиров).\
Если в запросе announce есть параметр с этим ключом (?gc), трекер запускает очистку "мертвых" пиров.

## Локальный запуск (консоль)

1. Установите зависимости:
```sh
pip install -r requirements.txt
```
2. Запустите сервер:
```sh
python3 main.py
```

---

## Запуск как systemd-сервис

1. Скопируйте и отредактируйте `retracker.service_example`:
    - Укажите абсолютные пути к рабочей директории и main.py
    - Укажите пользователя и группу

2. Скопируйте файл в `/etc/systemd/system/retracker.service` и выполните:

```sh
sudo systemctl daemon-reload
sudo systemctl enable --now retracker
```

---

## Вход в статистику

- Откройте `http://ваш_сервер/stat` в браузере.
- Введите логин и пароль из секции `[STATS]` файла config.ini.

---

## Обновление

```
git pull 

systemctl restart retracker

```

---

## Лицензия

MIT

---

Автор: [MakarSPB](https://github.com/Makar-aka)